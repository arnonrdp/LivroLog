name: Debug Development Server

on:
  workflow_dispatch:

env:
  PHP_VERSION: '8.3'
  NODE_VERSION: '20'

permissions:
  contents: read
  packages: write

jobs:
  debug-dev-server:
    name: debug-dev-server
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH and debug server
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/debug_key
          chmod 600 ~/.ssh/debug_key
          
          # SSH Config
          echo "Host ${{ secrets.SERVER_HOST }}" >> ~/.ssh/config
          echo "  HostName ${{ secrets.SERVER_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.SERVER_USER }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/debug_key" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # Debug server status
          ssh ${{ secrets.SERVER_HOST }} << 'DEBUG_SCRIPT'
            echo "=== System Status ==="
            date
            uptime
            
            echo ""
            echo "=== Docker Status ==="
            docker --version
            systemctl status docker --no-pager || service docker status
            
            echo ""
            echo "=== Running Containers ==="
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            
            echo ""
            echo "=== LivroLog Dev Containers Status ==="
            docker ps -a | grep livrolog || echo "No LivroLog containers found"
            
            echo ""  
            echo "=== Docker Compose Status ==="
            cd /var/www/livrolog-dev/docker || echo "Docker directory not found"
            if [ -f docker-compose.dev.yml ]; then
              docker compose -f docker-compose.dev.yml ps
            else
              echo "docker-compose.dev.yml not found"
            fi
            
            echo ""
            echo "=== Network Status ==="
            ss -tlnp | grep -E ':8080|:8081|:3307|:6380' || echo "No services listening on expected ports"
            
            echo ""
            echo "=== Container Logs (API) ==="
            if docker ps | grep -q livrolog-api-dev; then
              echo "API Container Logs (last 20 lines):"
              docker logs livrolog-api-dev --tail=20
            else
              echo "API container not running"
            fi
            
            echo ""
            echo "=== Container Logs (Web) ==="
            if docker ps | grep -q livrolog-web-dev; then
              echo "Web Container Logs (last 20 lines):"
              docker logs livrolog-web-dev --tail=20
            else
              echo "Web container not running"
            fi
            
            echo ""
            echo "=== Environment Files ==="
            if [ -f /var/www/livrolog-dev/shared/.env.dev ]; then
              echo ".env.dev exists:"
              ls -la /var/www/livrolog-dev/shared/.env.dev
              echo "First 10 lines (sensitive info hidden):"
              head -10 /var/www/livrolog-dev/shared/.env.dev | sed 's/PASSWORD=.*/PASSWORD=***/'
            else
              echo ".env.dev not found"
            fi
            
            echo ""
            echo "=== Disk Usage ==="
            df -h
            
            echo ""
            echo "=== Memory Usage ==="
            free -h
            
          DEBUG_SCRIPT