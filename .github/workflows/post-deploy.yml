name: Post Deploy Configuration

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  configure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure Production Environment
        if: inputs.environment == 'Production'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update production .env with secrets
            cat > /var/www/livrolog/shared/.env << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=production
            APP_DEBUG=false
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=https://api.livrolog.com
            APP_FRONTEND_URL=https://livrolog.com

            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null

            MAIL_MAILER=ses
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME=LivroLog

            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION=us-east-1
            AWS_SES_REGION=us-east-1

            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database

            LOG_CHANNEL=daily
            LOG_LEVEL=error

            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}

            AMAZON_PA_API_ENABLED=false
            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF

            # Fix Apache ServerName
            sudo sed -i "s/ServerName .*/ServerName ${{ secrets.SERVER_HOST }}/" /opt/bitnami/apache2/conf/vhosts/livrolog.conf

            # Clear caches
            cd /var/www/livrolog/current/api
            php artisan cache:clear
            php artisan books:cache-clear
            php artisan config:clear

      - name: Configure Development Environment
        if: inputs.environment == 'Development'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update dev .env with secrets
            cat > /var/www/livrolog-dev/shared/.env.dev << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=development
            APP_DEBUG=true
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=https://api.dev.livrolog.com
            APP_FRONTEND_URL=https://dev.livrolog.com

            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog_dev
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null

            MAIL_MAILER=ses
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME="LivroLog Dev"

            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION=us-east-1
            AWS_SES_REGION=us-east-1

            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database

            LOG_CHANNEL=daily
            LOG_LEVEL=debug

            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}

            AMAZON_PA_API_ENABLED=false
            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF

            # Clear caches
            cd /var/www/livrolog-dev/current/api
            php artisan cache:clear
            php artisan books:cache-clear
            php artisan config:clear

      - name: Restart Queue Workers
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== Restarting Queue Workers ==="

            # Kill existing queue workers gracefully
            pkill -f "php artisan queue:work" || echo "No existing workers found"
            sleep 3

            # Function to start queue worker
            start_queue_worker() {
                local app_path="$1"
                local env_name="$2"
                
                if [ -d "$app_path/current/api" ]; then
                    cd "$app_path/current/api"
                    
                    # Create systemd-style background process that survives SSH disconnection
                    setsid php artisan queue:work \
                        --verbose \
                        --tries=3 \
                        --timeout=60 \
                        --max-jobs=100 \
                        --max-time=3600 \
                        --sleep=3 \
                        --rest=0 \
                        > storage/logs/queue-worker.log 2>&1 < /dev/null &
                    
                    # Get the PID and verify it started
                    sleep 1
                    local worker_pid=$(pgrep -f "php artisan queue:work")
                    
                    if [ -n "$worker_pid" ]; then
                        echo "$env_name queue worker started with PID: $worker_pid"
                        
                        # Save PID to file for future reference
                        echo "$worker_pid" > storage/logs/queue-worker.pid
                        
                        # Verify it's actually running
                        if ps -p "$worker_pid" > /dev/null; then
                            echo "$env_name queue worker verified running"
                        else
                            echo "WARNING: $env_name queue worker PID $worker_pid not found"
                        fi
                    else
                        echo "ERROR: Failed to start $env_name queue worker"
                        return 1
                    fi
                else
                    echo "Directory $app_path/current/api not found"
                fi
            }

            # Start production queue worker if in production
            if [ -d "/var/www/livrolog/current/api" ]; then
                start_queue_worker "/var/www/livrolog" "Production"
            fi

            # Start dev queue worker if in dev
            if [ -d "/var/www/livrolog-dev/current/api" ]; then
                start_queue_worker "/var/www/livrolog-dev" "Development"
            fi

            # Final verification
            echo "=== Current queue worker processes ==="
            pgrep -af "php artisan queue:work" || echo "No queue workers found"
            
            echo "=== Queue workers restart completed ==="

      - name: Restart Apache
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo /opt/bitnami/ctlscript.sh restart apache
