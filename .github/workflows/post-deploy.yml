name: Post Deploy Configuration

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  configure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure Production Environment
        if: inputs.environment == 'Production'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update production .env with secrets
            cat > /var/www/livrolog/shared/.env << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=production
            APP_DEBUG=false
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=https://api.livrolog.com
            APP_FRONTEND_URL=https://livrolog.com

            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null

            MAIL_MAILER=resend
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME=LivroLog

            RESEND_KEY=${{ secrets.RESEND_KEY }}

            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database

            LOG_CHANNEL=daily
            LOG_LEVEL=error

            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}

            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF

            # Fix Apache ServerName
            sudo sed -i "s/ServerName .*/ServerName ${{ secrets.SERVER_HOST }}/" /opt/bitnami/apache2/conf/vhosts/livrolog.conf

            # Clear caches (Docker containers)
            docker exec livrolog-api php artisan cache:clear || true
            docker exec livrolog-api php artisan books:cache-clear || true
            docker exec livrolog-api php artisan config:clear || true

      - name: Configure Development Environment
        if: inputs.environment == 'Development'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update dev .env with secrets
            cat > /var/www/livrolog-dev/shared/.env.dev << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=development
            APP_DEBUG=true
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=https://api.dev.livrolog.com
            APP_FRONTEND_URL=https://dev.livrolog.com

            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog_dev
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null

            MAIL_MAILER=resend
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME="LivroLog Dev"

            RESEND_KEY=${{ secrets.RESEND_KEY }}

            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database

            LOG_CHANNEL=daily
            LOG_LEVEL=debug

            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}

            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF

            # Clear caches (Docker containers)
            docker exec livrolog-api-dev php artisan cache:clear || true
            docker exec livrolog-api-dev php artisan books:cache-clear || true
            docker exec livrolog-api-dev php artisan config:clear || true

      - name: Restart Apache
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo /opt/bitnami/ctlscript.sh restart apache

  restart-queue-workers:
    name: Restart Queue Workers
    runs-on: ubuntu-latest
    needs: [configure]
    environment: ${{ inputs.environment }}

    steps:
      - name: Restart Laravel queue workers (Production)
        if: inputs.environment == 'Production'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            if docker ps | grep -q "livrolog-api"; then
              echo "ðŸ”„ Restarting Production queue workers..."
              docker exec livrolog-api php artisan queue:restart || true
              echo "âœ… Queue restart signal sent"
              echo "ðŸ“‹ Docker container status:"
              docker ps --filter "name=livrolog-api" --format "table {{.Names}}\t{{.Status}}"
            else
              echo "âš ï¸ Production container not found: livrolog-api"
            fi

      - name: Restart Laravel queue workers (Development)
        if: inputs.environment == 'Development'
        uses: appleboy/ssh-action@f9010ff7f1bbd7db1a0b4bab661437550cea20c0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            if docker ps | grep -q "livrolog-api-dev"; then
              echo "ðŸ”„ Restarting Development queue workers..."
              docker exec livrolog-api-dev php artisan queue:restart || true
              echo "âœ… Queue restart signal sent"
              echo "ðŸ“‹ Docker container status:"
              docker ps --filter "name=livrolog-api-dev" --format "table {{.Names}}\t{{.Status}}"
            else
              echo "âš ï¸ Development container not found: livrolog-api-dev"
            fi
