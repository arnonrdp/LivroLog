name: Post Deploy Configuration

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  configure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Configure Production Environment
        if: inputs.environment == 'Production'
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update production .env with secrets
            cat > /var/www/livrolog/shared/.env << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=production
            APP_DEBUG=false
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=http://${{ secrets.SERVER_HOST }}
            APP_FRONTEND_URL=http://${{ secrets.SERVER_HOST }}
            
            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null
            
            MAIL_MAILER=ses
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME=LivroLog
            
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION=us-east-1
            AWS_SES_REGION=us-east-1
            
            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database
            
            LOG_CHANNEL=daily
            LOG_LEVEL=error
            
            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}
            
            AMAZON_PA_API_ENABLED=false
            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF
            
            # Fix Apache ServerName
            sudo sed -i "s/ServerName .*/ServerName ${{ secrets.SERVER_HOST }}/" /opt/bitnami/apache2/conf/vhosts/livrolog.conf
            
            # Clear caches
            cd /var/www/livrolog/current/api
            php artisan cache:clear
            php artisan books:cache-clear
            php artisan config:clear
            
      - name: Configure Development Environment
        if: inputs.environment == 'Development'
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Update dev .env with secrets
            cat > /var/www/livrolog-dev/shared/.env.dev << 'EOF'
            APP_NAME=LivroLog
            APP_ENV=development
            APP_DEBUG=true
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=http://api.dev.livrolog.com
            APP_FRONTEND_URL=http://dev.livrolog.com
            
            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=livrolog_dev
            DB_USERNAME=root
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_PASSWORD=null
            
            MAIL_MAILER=ses
            MAIL_FROM_ADDRESS=noreply@livrolog.com
            MAIL_FROM_NAME="LivroLog Dev"
            
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION=us-east-1
            AWS_SES_REGION=us-east-1
            
            SESSION_DRIVER=file
            CACHE_DRIVER=file
            QUEUE_CONNECTION=database
            
            LOG_CHANNEL=daily
            LOG_LEVEL=debug
            
            GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY || '' }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID || '' }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET || '' }}
            
            AMAZON_PA_API_ENABLED=false
            AMAZON_SITESTRIPE_ENABLED=true
            OPEN_LIBRARY_ENABLED=true
            EOF
            
            # Clear caches
            cd /var/www/livrolog-dev/current/api
            php artisan cache:clear
            php artisan books:cache-clear
            php artisan config:clear
            
      - name: Restart Queue Workers
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== Restarting Queue Workers ==="
            
            # Kill existing queue workers
            pkill -f "php artisan queue:work" || echo "No existing workers found"
            sleep 2
            
            # Start production queue worker if in production
            if [ -d "/var/www/livrolog/current/api" ]; then
                cd /var/www/livrolog/current/api
                nohup php artisan queue:work --verbose --tries=3 --timeout=60 > storage/logs/queue-worker.log 2>&1 &
                echo "Production queue worker started with PID: $!"
            fi
            
            # Start dev queue worker if in dev
            if [ -d "/var/www/livrolog-dev/current/api" ]; then
                cd /var/www/livrolog-dev/current/api
                nohup php artisan queue:work --verbose --tries=3 --timeout=60 > storage/logs/queue-worker.log 2>&1 &
                echo "Dev queue worker started with PID: $!"
            fi
            
            echo "=== Queue workers restarted successfully ==="
            
      - name: Restart Apache
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo /opt/bitnami/ctlscript.sh restart apache