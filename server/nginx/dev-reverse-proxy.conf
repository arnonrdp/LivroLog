server {
    listen 443 ssl;
    server_name dev.livrolog.com;

    root /var/www/livrolog-dev/current/webapp;
    index index.html;

    ssl_certificate     /etc/letsencrypt/live/dev.livrolog.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dev.livrolog.com/privkey.pem;

    # Always proxy API shelf image and docs
    location ^~ /users/ { proxy_pass https://api.dev.livrolog.com; proxy_set_header Host $host; }
    location ^~ /docs/  { proxy_pass https://api.dev.livrolog.com; proxy_set_header Host $host; }

    # Proxy crawler requests for username routes to the API for OG rendering
    set $is_bot 0;
    if ($http_user_agent ~* (facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo|pinterest(bot)?|reddit(bot)?|embedly|iframely|opengraph|vkshare|qwantify|bitlybot|bufferbot|duckduckbot|baiduspider|yandex(bot)?|lighthouse|pagespeed)) {
        set $is_bot 1;
    }

    location ~ ^/([A-Za-z0-9_.-]+)/?$ {
        if ($is_bot) {
            return 307 https://api.dev.livrolog.com$request_uri;
        }
        try_files /index.html =404;
    }

    location = / {
        if ($is_bot) {
            return 307 https://api.dev.livrolog.com/;
        }
        try_files /index.html =404;
    }

    # SPA fallback for all other routes
    location / { try_files $uri /index.html; }
}

