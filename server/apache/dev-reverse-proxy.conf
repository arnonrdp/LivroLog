<VirtualHost *:443>
    ServerName dev.livrolog.com
    DocumentRoot /var/www/livrolog-dev/current/webapp

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/dev.livrolog.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/dev.livrolog.com/privkey.pem

    # Reverse proxy: serve OG pages from the API without redirects
    ProxyPreserveHost On
    ProxyRequests Off
    SSLProxyEngine On
    ProxyPassReverse / https://api.dev.livrolog.com/

    RewriteEngine On
    # /username (single segment), bots or ?og=1 → proxy to API
    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_-]+)/?$ 
    RewriteCond %1 !^(api|login|register|reset-password|documentation|privacy|terms|sitemap\.xml|robots\.txt|assets|favicon\.ico)$ [NC]
    RewriteRule ^ https://api.dev.livrolog.com%{REQUEST_URI}?%{QUERY_STRING} [P,L]

    # Homepage for bots or ?og=1 → proxy to API
    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^ https://api.dev.livrolog.com/ [P,L]

    # SPA fallback
    FallbackResource /index.html

    <Directory "/var/www/livrolog-dev/current/webapp">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

