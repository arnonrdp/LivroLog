# docker-compose.prod.yml
# Production Docker Compose with internal network and loopback ports
# Comments in English only

name: livrolog

services:
  # Laravel API with Nginx + PHP-FPM
  api:
    image: ghcr.io/${OWNER:-arnonrdp}/livrolog-api:${TAG:-prod}
    container_name: livrolog-api
    restart: always
    env_file:
      - /var/www/livrolog/shared/.env
    environment:
      # Override DB/Redis to use external services (existing MariaDB/Redis)
      - DB_HOST=127.0.0.1
      - DB_PORT=3306
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
    # Use host network to access external MariaDB/Redis on localhost
    network_mode: host
    ports:
      - "127.0.0.1:18081:8080"
    volumes:
      # Mount shared storage from existing deployment
      - /var/www/livrolog/shared/storage:/var/www/html/storage
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Vue/Quasar WebApp served by Nginx
  web:
    image: ghcr.io/${OWNER:-arnonrdp}/livrolog-web:${TAG:-prod}
    container_name: livrolog-web
    restart: always
    ports:
      - "127.0.0.1:18080:80"
    networks:
      - livrolog-net
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -fsS http://localhost/healthz && curl -fsS http://127.0.0.1:18081/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

networks:
  livrolog-net:
    name: livrolog-net
    driver: bridge