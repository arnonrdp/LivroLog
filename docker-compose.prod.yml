# docker-compose.prod.yml
# Production Docker Compose with internal network and loopback ports
# Comments in English only

name: livrolog

services:
  # Laravel API with Nginx + PHP-FPM (serves on port 8080)
  api:
    image: ghcr.io/${OWNER:-arnonrdp}/livrolog-api:${TAG:-prod}
    restart: always
    environment:
      # Override DB/Redis to use external services via host gateway
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
    ports:
      - "127.0.0.1:18081:8080"
    networks:
      - livrolog-net
    volumes:
      # Mount shared storage and .env from existing deployment
      - /var/www/livrolog/shared/storage:/var/www/html/storage
      - /var/www/livrolog/shared/.env:/var/www/html/.env:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Vue/Quasar WebApp served by Nginx
  web:
    image: ghcr.io/${OWNER:-arnonrdp}/livrolog-web:${TAG:-prod}
    restart: always
    ports:
      - "127.0.0.1:18080:80"
    networks:
      - livrolog-net
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/healthz"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

networks:
  livrolog-net:
    name: livrolog-net
    driver: bridge