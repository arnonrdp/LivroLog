RewriteEngine On

# Detect common social/crawler user agents
SetEnvIfNoCase User-Agent "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo|pinterest(bot)?|reddit(bot)?|embedly|iframely|opengraph|vkshare|qwantify|bitlybot|bufferbot|duckduckbot|baiduspider|yandex(bot)?|lighthouse|pagespeed)" is_bot=1

# ========================= DEV (dev.livrolog.com) =========================
# Always send OG assets to API
RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
RewriteRule ^users/(.*)$ https://api.dev.livrolog.com/users/$1 [R=307,L]
RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
RewriteRule ^docs/(.*)$ https://api.dev.livrolog.com/docs/$1 [R=307,L]

# Username page for crawlers → API
RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
RewriteCond %{ENV:is_bot} =1 [OR]
RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
RewriteCond %{QUERY_STRING} (^|&)og=1(&|$)
RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
RewriteCond %1 !^(api|login|register|reset-password|documentation|privacy|terms|sitemap\.xml|robots\.txt|assets|favicon\.ico|og|docs|users)$ [NC]
RewriteRule ^ https://api.dev.livrolog.com%{REQUEST_URI}?%{QUERY_STRING} [R=307,L]

# ========================= PROD (livrolog.com / www) =========================
# Always send OG assets to API
RewriteCond %{HTTP_HOST} ^(www\.)?livrolog\.com$ [NC]
RewriteRule ^users/(.*)$ https://api.livrolog.com/users/$1 [R=307,L]
RewriteCond %{HTTP_HOST} ^(www\.)?livrolog\.com$ [NC]
RewriteRule ^docs/(.*)$ https://api.livrolog.com/docs/$1 [R=307,L]

# Username page for crawlers → API
RewriteCond %{HTTP_HOST} ^(www\.)?livrolog\.com$ [NC]
RewriteCond %{ENV:is_bot} =1 [OR]
RewriteCond %{HTTP_HOST} ^(www\.)?livrolog\.com$ [NC]
RewriteCond %{QUERY_STRING} (^|&)og=1(&|$)
RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
RewriteCond %1 !^(api|login|register|reset-password|documentation|privacy|terms|sitemap\.xml|robots\.txt|assets|favicon\.ico|og|docs|users)$ [NC]
RewriteRule ^ https://api.livrolog.com%{REQUEST_URI}?%{QUERY_STRING} [R=307,L]

# Let the SPA handle other routes (fallback handled by server config)
