# Redirect www to non-www and force HTTPS
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Force HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
    
    # Redirect www to non-www
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Server-side redirect for social media crawlers (and testers with ?og=1) to API for dynamic OG tags
    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
    RewriteCond %1 !^(api|login|register|reset-password|documentation|privacy|terms|sitemap\.xml|robots\.txt|assets|favicon\.ico)$ [NC]
    RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
    RewriteRule ^ https://api.dev.livrolog.com%{REQUEST_URI} [R=302,L]

    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
    RewriteCond %1 !^(api|login|register|reset-password|documentation|privacy|terms|sitemap\.xml|robots\.txt|assets|favicon\.ico)$ [NC]
    RewriteCond %{HTTP_HOST} ^livrolog\.com$ [NC]
    RewriteRule ^ https://api.livrolog.com%{REQUEST_URI} [R=302,L]

    # Optional: homepage OG for crawlers (send bots to API root)
    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/$
    RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
    RewriteRule ^ https://api.dev.livrolog.com/ [R=302,L]

    RewriteCond %{QUERY_STRING} (^|&)og=1(&|$) [OR]
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|facebookcatalog|twitterbot|linkedinbot|whatsapp|telegram(bot)?|slack(-imgproxy|-bot|bot)?|discordbot|skypeuripreview|applebot|google(bot|-inspectiontool)|bingbot|yahoo!|pinterest(bot)?|reddit(bot)?|embedly|vkshare|qwantify|bitlybot|bufferbot|iframely|opengraph|lighthouse|pagespeed|duckduckbot|baiduspider|yandex(bot)?)" [NC]
    RewriteCond %{REQUEST_URI} ^/$
    RewriteCond %{HTTP_HOST} ^livrolog\.com$ [NC]
    RewriteRule ^ https://api.livrolog.com/ [R=302,L]

    # Handle SPA routing
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"

    # Cache de 1 ano para assets com hash (JS, CSS, fontes)
    <FilesMatch "\.(js|css|woff2?|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, immutable"
    </FilesMatch>

    # Cache de 7 dias para imagens
    <FilesMatch "\.(png|jpg|jpeg|gif|webp|svg|ico)$">
        Header set Cache-Control "max-age=604800, public"
    </FilesMatch>

    # SEM cache para index.html e service worker
    <FilesMatch "(index\.html|sw\.js|site\.webmanifest)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>
