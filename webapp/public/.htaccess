# Redirect www to non-www and force HTTPS
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Force HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
    
    # Redirect www to non-www
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Server-side redirect for social media crawlers to API for dynamic OG tags
    # Matches username-like paths at site root (e.g., /arnon, /wanderson)
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|twitterbot|linkedinbot|whatsapp|telegrambot|slackbot|discordbot|skypeuripreview|applebot|googlebot|bingbot|yahoo|pinterest|redditbot)" [NC]
    RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
    # Exclude common non-profile routes
    RewriteCond %1 !^(api|login|register|reset-password|documentation)$ [NC]
    # Dev environment host → dev API
    RewriteCond %{HTTP_HOST} ^dev\.livrolog\.com$ [NC]
    RewriteRule ^ https://api.dev.livrolog.com%{REQUEST_URI} [R=302,L]

    # Production host → production API
    RewriteCond %{HTTP_USER_AGENT} "(facebookexternalhit|twitterbot|linkedinbot|whatsapp|telegrambot|slackbot|discordbot|skypeuripreview|applebot|googlebot|bingbot|yahoo|pinterest|redditbot)" [NC]
    RewriteCond %{REQUEST_URI} ^/([A-Za-z0-9_.-]+)/?$ 
    RewriteCond %1 !^(api|login|register|reset-password|documentation)$ [NC]
    RewriteCond %{HTTP_HOST} ^livrolog\.com$ [NC]
    RewriteRule ^ https://api.livrolog.com%{REQUEST_URI} [R=302,L]

    # Handle SPA routing
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

